

数据都存储在内存当中，在处理客户端请求时，所有操作都在内存中进行，只要服务器关机，内存中的数据就会消失，不仅服务器关机会造成数据消失，redis服务器守护进程退出，内存中的数据也一样会消失。



# 持久化

为了避免内存中数据丢失，redis提供了对持久化的支持，将数据从内存中保存到硬盘当中。redis提供了RDB(redis database)和AOF(append only file)两种不同的数据持久化方式。

## RDB(redis database)

RDB是一种快照存储持久化方式，具体就是将redis某一时刻的内存数据保存到硬盘的文件当中，而在redis服务器启动时，会重新加载文件的数据到内存当中恢复数据。

三种方式

- save命令
- bgsave命令
- 自动触发



### 触发方式

#### save命令

当客户端向服务器发送save命令请求持久化时，服务器会阻塞save命令之后的其他客户端亲故，直到数据同步完成。如果数据量太大，同步数据会执行很久，而这期间redis服务器无法接收其他请求，所以醉话不要在生产环境使用save命令

#### bgsave命令

异步保存数据到磁盘上

当客户端向服务器发送bgsave命令，redis服务器主进程会forks一个子进程来同步数据，在讲数据保存到rdb文件之后，子进程会退出。与save命令相比，redis服务器在处理bgsave采用子线程进行IO写入，而主进程仍然可以接收其他请求，但forks子进程是同步的，所以forks子进程时一样不能接收其他请求，这意味着，如果forks一个子进程花费的时间太久(一般是很快的)，bgsave命令仍然有阻塞其他客户端请求的情况发生。

#### 自动触发

在redis配置文件中的save指定到达触发RDB持久化的条件，比如【多少秒内至少达到多少写操作】就开始RDB数据同步。

这种通过服务器配置文件触发RDB的方式，与bgsave命令类似，达到触发条件时，会forks一个子进程进行数据同步，不过通过这种方式来触发RDB持久化，如果设置触发的时间太短，则容易频繁写入rdb文件，影响服务器性能，时间设置太长则会造成数据丢失。



### 优点

- 与AOF相比，通过rdb文件恢复数据比较快
- rdb文件非常紧凑，适合于数据备份
- 通过RDB进行数据备份，由于使用子进程生成，所以对redis服务器性能影响较小



### 缺点

- 如果服务器宕机，采用RDB方式会造成某个时间段内的数据丢失
- 使用save命令会造成服务器阻塞，直到数据同步完成后才能接收后续请求
- 使用bgsave命令在forks子进程时，如果数据量太大，forks的过程也会发生阻塞，另外，forks子进程会耗费内存



## AOF(append only file)

AOF持久化方式会记录客户端对服务器的每一次写操作命令，并将这些写操作以redis协议追加保存到一后缀为aof文件末尾，在redis服务器重启时，会加载并运行aof文件的命令，进行恢复数据。默认不开启AOF持久化。aof文件是一个二进制文件

### 三种写入策略

#### always

客户端的每一个写操作都保存到aof文件中，这种策略很安全，但是每一写请求都有IO操作，所以也很慢

#### everysec

appendsync的默认写入策略，每秒写入一次aof文件，因此，最多可能会丢失1s的数据

#### no

redis服务器不负责写入aof，而是交由操作系统来处理什么时候写入aof文件。更快，但也是最不安全的选择，不推荐使用



### AOF文件重写

AOF将客户端的每一个写操作都追加到aof命令末尾，可能会造成aof文件变得非常大。aof文件太大，加载aof文件恢复数据时，就会非常慢，为了解决这个问题，reids支持aof文件重写，通过重写aof，可以生成一个恢复当前数据的最少命令集。

#### 

### 两种重写方式

1. 在redis配置文件中的选项 no-appendfsync-on-rewrite 可以设置是否开启重写，这种方式会在每次fsync时都会重写，影响服务器性能，因此默认值为no，不推荐使用
2. 客户端向服务器发送bgrewriteaof命令，也可以让服务器进行AOF重写。



### 重写aof的好处

- 压缩aof文件，减少磁盘占用量
- 将aof的命令压缩为最小命令集，加快了数据恢复的速度



### AOF文件损坏

```
redis-check-aof -fix file.aof
```



### 优点

AOF只是追加日志文件，因此对服务器性能影响较小，速度比RDB要快，消耗的内存较少

### 缺点

- AOF方式生成的日志文件太大，即使通过AOF重写，文件体积仍然很大
- 恢复数据的速度比RDB慢



当RDB与AOF两种都开启时，redis会优先使用AOF来恢复数据，因为AOF保存的文件比RDB文件更完整。

# 参考资料

[10 分钟彻底理解 Redis 的持久化和主从复制](https://mp.weixin.qq.com/s/ZGamPtfIZaMwUk1DU3iDnQ)